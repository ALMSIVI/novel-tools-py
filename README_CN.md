# 小说整理工具

[English README](/README.md)

## 为什么要做这个工具

首先声明，本人支持正版，在可能的情况下，请上官网购买/订阅作品。我的这套工具基本都用于全本订阅的小说。

但是，起点等网站会因各种原因下架小说的部分/全部章节，严重影响阅读体验。在这种情况下，不得不在网络上下载txt版本。txt本身没有格式，如果你是随便读读，那并没有多大问题。但如果你希望将小说转换为更适合电子书的格式（如epub），那么就会出问题。即使部分阅读软件有格式匹配功能，能够自动生成目录，但部分问题仍然无法解决：

- 无法支持自定义格式的卷名/章节名。

  - 某些小说可能不会采用正统的章节名。例如：「少女之战第X幕」。

- 由于作者疏忽，章节名会有重复/遗漏。

  - 例如出现两个100章，或者100章之后直接变成102章。

- 章节名字的格式不规则。

  - 比如中文数字与阿拉伯数字混用，或者「章」后面是否有空格。

如果小说中存在这些问题，生成的目录并不完整且错误百出，也会影响阅读体验。这套工具试图用一套统一的框架来分析小说，生成更好的目录，并对小说进行排版。虽然每个小说的问题各不相同，不太可能会存在一套通用的脚本来处理所有的小说，但是我们至少可以用这套工具生成一个简单的结构文件，再根据需要手动修改。

## 未来计划

因为这套工具提供的功能目前对我来说已经够用，以下列举的功能并没有具体实现日期。

- [ ] 使用[PyQt](https://wiki.python.org/moin/PyQt)创建GUI。
- [ ] 利用[ebooklib](http://docs.sourcefabric.org/projects/ebooklib/en/latest/)以及[Python Markdown](https://python-markdown.github.io/)实现`EpubWriter`。Caliber自带的转换功能很好用，但它转换较大文件时非常吃力。因为只有一个Markdown文件，用户很难自定义样式，或者添加插图。因此，我们需要自行搭建一个Writer以创造一个更好看、更多样的epub文件。
- [ ] 创建一个[Calibre插件](https://manual.calibre-ebook.com/creating_plugins.html)。因为用户需要手动检查错误、更正源文件，这个插件应该无法实现`analyze`中的功能。但是它应该可以提供比`calibredb`更为丰富的功能。

## 安装

这个项目使用[Poetry](https://python-poetry.org/)进行管理，基于Python 3.9。再安装完Poetry之后，使用`poetry install`命令安装所有依赖，使用`poetry run pytest`运行全部测试。

如果你只想使用这套工具，而不想进行开发，你可以使用`poetry install --no-dev`。

如果你没有Poetry，你需要手动安装依赖。目前，唯一需要的库是`natsort`，用来对数字进行自然排序（1, 2, ..., 10, 11而非1, 10, 11, ..., 2）。你可以使用pip来安装：

```shell
pip3 install natsort
```

## 基本概念

- 小说，或者任何书籍，由**分卷**和**章节**组成。部分小说只有章节，而没有分卷。
- 分卷和章节都会由**标题**表示，我们称其为**分卷标题**和**章节标题**。
- 小说可能会在文件开头有**书籍简介**，在分卷开头也可能有**分卷简介**。
- 因此，一本小说的结构通常可以表示为：**书籍标题**——书籍简介——分卷标题——分卷简介——章节标题——**章节内容**——……
- **常规标题**包含**编号**和**内容**。有时候标题没有内容，但必须要有编号。例：*第1章 逃脱*的编号为*1*，内容为*逃脱*。
- 有时候同一本书中会存在多组编号。比如说在普通章节中会插入一些「番外」章节。这些番外独立于普通章节编号。
- **特殊标题**不含有编号。和常规标题一样，内容可有可无，但它们会包含一些可以轻易辨别的**词缀**。例：*简介*，*前言*，*总结*。
- **元数据**指与书籍本身内容无关的内容，例如作者名、id、语言和标签。如果你需要在例如[Calibre](https://calibre-ebook.com/)之类的软件中管理这些数据，这些数据十分有用。元数据模板可以在[此处](config/sample_metadata.json)找到。

这套工具主要用于从小说文件中提取不同的内容，纠正任何可能存在的问题，并对其重新排版使其更规整更好看。

## 用法

如果你在用Poetry，使用`poetry run cli -h`唤出可用的命令和参数。如果没有Poetry（或者在使用Poetry shell），那么你可以使用`python3 ntcli.py -h`。

在下载小说后，先移除任何可能存在的广告。通常有两种工作流程：

1. 创造一个「结构文件」记录如何找到分卷和章节标题，如何对它们进行格式化。（**struct**）
2. 手动检查结构文件，修改任何问题。如果有必要的话，也可以修改小说源文件，但记得在修改后重新生成结构文件，或者修改它使其匹配修改后的源文件。
3. 利用结构文件和源文件，重新排版小说。（**create**）

你也可以这么做：

1. 将源文件分割，每个分卷为一个文件夹，每一个章节为一个文件。（**split**）
2. 手动检查分卷名和章节文件，修改任何问题。很多文本编辑器对体积较大的源文件的支持并不好，分割后可以避免直接对大文件进行编辑。
3. 基于分卷和章节文件，重新生成「结构文件」。（**struct_dir**）
4. 手动检查结构文件，修改任何问题。如果小说包含特殊分卷或章节，它们的排序可能会在分割中遗失（因为它们没有序号）。这种情况下你需要手动对这些标题进行排序。
5. 利用结构文件和分卷、章节文件，重新排版小说。（**create_dir**）

可选：你可以为你的小说创建一个元数据文件，并在小说中包含这些元数据。

在你得到排版后的小说后，你将其导入到[Calibre](https://calibre-ebook.com/)等电子书管理软件中，并将其转化为适合电纸书阅读的格式（即epub）。（**add**和**convert**）

如果你想要使用以上两个工具，你需要元数据文件，以及书籍封面，命名为`cover.jpg`。

## 例子和文档

你可以查看[集成测试](/tests/toolkit)来了解这套工具可以处理哪些小说格式，生成哪些文件。如果你想为自己的小说创造自己的配置，你可以参考这些测试的配置，以及 [默认配置](/config)。内置类的文档的参考在[这里](/docs/references.md)。

这套工具扩展性很强，你可以根据需要自行编写组件。请参阅[设计文档](/docs/design.md)了解项目构造，以及每个组件的用途。
