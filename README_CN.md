# 小说整理工具

## 为什么要做这个工具

首先声明，本人支持正版，在可能的情况下，请上官网订阅作者。我的这套工具基本都用于全本订阅的小说。

但是，起点等网站会因各种原因下架小说的部分/全部章节，严重影响阅读体验。在这种情况下，不得不在网络上下载txt版本。txt本身没有格式，即使部分阅读软件有格式匹配能够自动生成目录，但部分问题仍然无法解决：

- 无法支持自定义格式的卷名/章节名。

某些小说可能不会采用正统的章节名。例如：「少女之战第X幕」。

- 由于作者疏忽，章节名会有重复/遗漏。

例如出现两个100章，或者100章之后直接变成102章。

- 章节名字的格式不规则。

比如中文数字与阿拉伯数字混用，或者「章」后面是否有空格。

对于强迫症患者来说，这是无法接受的。虽然每个小说的问题各不相同，不太可能可以用一套通用的脚本来处理所有的小说，但是脚本至少可以对章节进行简单的自动分割，再进行手动调整。

## 额外库

你需要`natsort`来对数字进行自然排序（1, 2, ..., 10而非1, 10, 11, ..., 2）。

```shell
pip3 install natsort
```

## 使用方法

- 所有的脚本都有`argparse`，可以通过`-h`参数来查看使用指南。

小说下载下来之后，先删去前后的网站声明、书名、简介等无关内容，只留下卷名和章节名。同时确保文件为**utf8**编码，而非gb2312。

然后使用`split.py`拆分章节。该脚本能够将txt文件分拆成单个的Markdown文件，其中标题会用**h1**表示在第一行。如果该小说有分卷，那么脚本能够识别简单的卷名，并将每一卷中的章节放在单独的文件夹内。

对于更加复杂或者不规则的卷名，你需要生成一个`volumes.json`来帮助脚本识别卷名。json的格式如下：

```json
[
    {
        "name": "the directory of the volume (to be created by the script)",
        "volume": "the name of the volume (to be matched in the text file)"
    },
]
```

拆分章节后，需要手动校对目录、分卷信息，确保章节数和文件数统一。

如果分卷的名字不规则，不符合自然排序规则，那么需要手动排序。调整`volumes.json`中分卷的顺序，以帮助`contatenate.py`确定分卷顺序。你现在已经有了所有的分卷目录，因此可以使用`generate_order.py`来自动生成这个json文件。

如果小说的分卷有简介，那么将其存为`_intro.txt`并放入各自的分卷目录中。因为章节会自然排序，前面的下划线可以保证简介文件被第一个读取。对于小说的简介，将`_intro.txt`放入主目录下。脚本会自动检测该文件并将其放入合并过后的文档中。

即使小说没有分卷，也请将所有的章节文件放在一个子目录下。你的工作路径会清爽很多，你也实现了元文件和章节文件的分离。你可以通过调整参数使脚本不生成卷名。

然后，你就可以使用`concatenate.py`来合并所有的分卷/章节，保存到一个统一的Markdown文件中。

现在，你就可以将整理完成的文件导入到Calibre等电子书管理软件中，统一进行管理。你可以手动操作，亦可以使用`add_to_calibre.py`和`calibre_convert.py`。对于这两个脚本，你需要下载一张封面图，保存为`cover.jpg`。你同时需要手动生成一个`metadata.json`文件以保存元信息，模板如下：

```json
{
    "title": "My Favorite Book",
    "author": "Best author in the world",
    "id": "isbn:1234567890",
    "tags": ["Fiction"],
    "publisher": "Hello World",
    "languages": ["English"]
}
```
